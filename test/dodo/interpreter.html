<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Interpreter</title>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <link rel="stylesheet" href="../style.css"/>
        <script type="module">

import test from "../test.js";
import parse, { Backtick, Space, consolidateText } from "../../dodo/parser.js";
import run from "../../dodo/interpreter.js";

test("Self-evaluating expression (number)", t => {
    t.same(run("{ seq `17 }"), 17, "number");
});

test("Self-evaluating expression (string)", t => {
    t.same(run(`{ seq "Hello, world!" }`), "Hello, world!", "string");
});

test("Variable", t => {
    t.typeof(run("{ seq `unquote }"), "symbol", "defined variable");
    t.true(run("{ seq `true }"), "true variable");
    t.same(run("{ seq `false }"), false, "false variable");
});

test("Undefined variable error", t => {
    t.throws(() => run("{ seq `foo }"), "throws");
});

test("Unquote special form", t => {
    t.same(run("{ seq `unquote }"), run("{ unquote unquote }"), "{ unquote x } â‰¡ `x");
    t.throws(() => run("{ unquote }"), "accepts only a single argument (zero arguments)");
    t.throws(() => run("{ unquote foo bar baz }"), "accepts only a single argument (too many)");
});

test("set! special form", t => {
    t.same(run("{ set! set! `23 }"), 23, "returns the new value");
    t.same(run("{ seq { set! set! `23 } `set! }"), 23, "after setting it");
    t.throws(() => run("{ set! x `23 }"), "can only set the value of a defined variable");
    t.throws(() => run("{ set! `set! `23 }"), "variable name must be a string");
});

test("Define special form", t => {
    t.same(run("{ define x `23 }"), 23, "returns the new value");
    t.same(run("{ seq { define x `23 } `x }"), 23, "after setting it");
    t.throws(() => run("{ seq { define x `23 } { define x `17 } }"), "cannot redefine a value in the same scope");
    t.throws(() => run("{ define `x `23 }"), "variable name must be a string");
});

test("if special form", t => {
    t.same(run("{ if `true `23 ko }"), 23, "predicate is true");
    t.same(run("{ if \"false\" `23 ko }"), 23, "predicate is truthy (false as string)");
    t.same(run("{ if `0 `23 ko }"), 23, "predicate is truthy (0)");
    t.same(run("{ if `{} `23 ko }"), 23, "predicate is truthy (empty list)");
    t.same(run("{ if `false ko `23 }"), 23, "predicate is false");
});

test("Application", t => {
    t.same(run("{ + `17 `23 `19 }"), 59, "+ (with arguments)");
    t.same(run("{ * }"), 1, "* (no argument)");
    t.throws(() => { run("{ ??? foo bar }"); }, "undefined value");
    t.throws(() => { run("{ seq { define f `23 } { f `17 } }"); }, "not a function");
});

test("lambda special form", t => {
    t.typeof(run("{ lambda `{ x } { + `x `1 } }"), "function", "creates a function");
    t.typeof(run("{ Î» x { + `x `1 } }"), "function", "short form (Î», single parameter)");
    t.same(run("{ { Î» x { + `x `1 } } `17 }"), 18, "may be applied");
    t.same(run("{ seq { define !- { lambda `{ x y } { - `y `x } } } { !- `17 `23 } }"), 6, "define and call with arguments");
});

test("define for functions", t => {
    t.same(run("{ seq { define incr `{ x } { + `1 `x } } { incr `23 } }"), 24, "single parameter");
    t.same(run("{ seq { define !- `{ x y } { - `y `x } } { !- `17 `23 } }"), 6, "multiple parameters");
});

test("Self-evaluating expression (raw number)", t => {
    t.same(run("{ seq 17 }"), 17, "number");
});

test("Variable (raw)", t => {
    t.typeof(run("{ seq unquote }"), "symbol", "defined variable");
    t.true(run("{ seq true }"), "true variable");
    t.same(run("{ seq false }"), false, "false variable");
});

test("Undefined variable error (raw)", t => {
    t.throws(() => run("{ seq foo }"), "throws");
});

test("set! special form (raw)", t => {
    t.same(run("{ set! set! 23 }"), 23, "returns the new value");
    t.same(run("{ seq { set! set! 23 } set! }"), 23, "after setting it");
    t.throws(() => run("{ set! x 23 }"), "can only set the value of a defined variable");
});

test("define special form (raw)", t => {
    t.same(run("{ define x 23 }"), 23, "returns the new value");
    t.same(run("{ seq { define x 23 } x }"), 23, "after setting it");
    t.throws(() => run("{ seq { define x 23 } { define x 17 } }"), "cannot redefine a value in the same scope");
});

test("if special form (raw)", t => {
    t.same(run("{ if true 23 ko }"), 23, "predicate is true");
    t.same(run("{ if \"false\" 23 ko }"), 23, "predicate is truthy (false as string)");
    t.same(run("{ if 0 23 ko }"), 23, "predicate is truthy (0)");
    t.same(run("{ if `{} 23 ko }"), 23, "predicate is truthy (empty list)");
    t.same(run("{ if false ko 23 }"), 23, "predicate is false");
});

test("Application (raw)", t => {
    t.same(run("{ + 17 23 19 }"), 59, "+ (with arguments)");
    t.same(run("{ * }"), 1, "* (no argument)");
    t.throws(() => { run("{ ??? foo bar }"); }, "undefined value");
    t.throws(() => { run("{ seq { define f 23 } { f 17 } }"); }, "not a function");
});

test("lambda special form (raw)", t => {
    t.typeof(run("{ lambda `{ x } { + x 1 } }"), "function", "creates a function");
    t.typeof(run("{ Î» x { + x 1 } }"), "function", "short form (Î», single parameter)");
    t.same(run("{ { Î» x { + x 1 } } 17 }"), 18, "may be applied");
    t.same(run("{ seq { define !- { lambda `{ x y } { - y x } } } { !- 17 23 } }"), 6, "define and call with arguments");
});

test("define for functions (raw)", t => {
    t.same(run("{ seq { define incr `{ x } { + 1 x } } { incr 23 } }"), 24, "single parameter");
    t.same(run("{ seq { define !- `{ x y } { - y x } } { !- 17 23 } }"), 6, "multiple parameters");
});

        </script>
    </head>
    <body>
        <h1>Testinâ€™ Dodo ðŸ¦¤: Interpreter</h1>
        <div class="tests"></div>
        <p>
            <a href="../dodo.html">Back</a>
        </p>
    </body>
</html>
