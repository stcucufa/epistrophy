<!DOCTYPE html>
<html>
    <head>
        <title>VM</title>
        <meta charset="utf8">
        <link rel="stylesheet" href="test.css">
        <script type="module">

import { test } from "./test.js";
import { notification } from "../lib/events.js";
import { K } from "../lib/util.js";
import { VM } from "../lib/vm.js";

test("VM()", t => {
    const vm = VM();
    t.equal(vm.clock.now, 0, "clock starts at 0");
});

test("Start the clock", async t => {
    const vm = VM().start();
    await notification(vm.clock, "update");
    t.above(vm.clock.now, 0, `clock started (${vm.clock.now})`);
});

test("spawn(t = now)", t => {
    const vm = VM();
    const thread = vm.spawn();
    thread.instant(K("ok"));
    vm.clock.seek(1);
    t.equal(vm.valueOf(thread), "ok", "thread value");
});

test("spawnAt(t)", t => {
    const vm = VM();
    const thread = vm.spawnAt(17);
    thread.instant(K("ok"));
    vm.clock.seek(18);
    t.equal(vm.valueOf(thread), "ok", "thread value");
});

test("Run forward", t => {
    const vm = VM();
    const thread = vm.spawnAt(17);
    const succ = x => `succ(${x})`;
    thread.instant(K("zero"));
    thread.delay(23);
    thread.instant(succ);
    thread.delay(31);
    thread.instant(succ);
    vm.clock.seek(17);
    t.undefined(vm.valueOf(thread), "no value before t0");
    vm.clock.seek(18);
    t.equal(vm.valueOf(thread), "zero", "value in [t0, t1[");
    vm.clock.seek(41);
    t.equal(vm.valueOf(thread), "succ(zero)", "value in [t1, t2[");
    vm.clock.seek(72);
    t.equal(vm.valueOf(thread), "succ(succ(zero))", "value after t2");
});

test("Run backward", t => {
    const vm = VM();
    const thread = vm.spawnAt(17);
    const succ = x => `succ(${x})`;
    thread.instant(K("zero"));
    thread.delay(23);
    thread.instant(succ);
    thread.delay(31);
    thread.instant(succ);
    vm.clock.seek(72);
    t.equal(vm.valueOf(thread), "succ(succ(zero))", "value after t2");
    vm.clock.seek(71);
    t.equal(vm.valueOf(thread), "succ(zero)", "value in [t1, t2[");
    vm.clock.seek(40);
    t.equal(vm.valueOf(thread), "zero", "value in [t0, t1[");
    vm.clock.seek(17);
    t.undefined(vm.valueOf(thread), "no value before t0");
});

        </script>
    </head>
    <body>
        <p><a href="index.html">Back</a></p>
    </body>
</html>
