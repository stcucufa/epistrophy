<!DOCTYPE html>
<html>
    <head>
        <title>Timeline</title>
        <meta charset="utf8">
        <link rel="stylesheet" href="test.css">
        <script type="module">

import { test } from "./test.js";
import { K, nop } from "../lib/util.js";
import { Timeline } from "../lib/timeline.js";
import { VM } from "../lib/vm.js";
import { Thread } from "../lib/thread.js";

test("Timeline(vm)", t => {
    const vm = VM();
    const timeline = Timeline(vm);
    t.equal(timeline.vm, vm, "vm");
    t.instanceof(timeline.element, Element, "element");
});

test("Add and highlight elements", t => {
    const vm = VM();
    const timeline = Timeline(vm);

    const thread = vm.spawn();
    thread.instant(K("ok?"));
    thread.delay("3.3s");
    thread.instant(v => v.replace(/\?/, "!"));

    vm.clock.seek(1);
    const track = timeline.element.querySelector("g.track");
    t.equal(track.children.length, 2, "track contents count (support/items)");
    t.equal(track.firstChild.firstChild.tagName, "line", "line for track");
    const items = track.lastChild;
    const current = [...items.querySelectorAll(".current")];
    t.equal(current.length, 2, "current items");
    t.equal(current[0].tagName, "circle", "circle for zero dur item");
    t.equal(current[1].tagName, "rect", "rect for non-zero dur item");

    vm.clock.seek(3333);
    t.equal(items.children.length, 3, "new content added");
});

test("Show jump", t => {
    const vm = VM();
    const timeline = Timeline(vm);

    const thread = vm.spawnAt(17).
        instant(K(0)).
        label("loop").
        delay(23).
        instant(x => x + 1).
        jump("loop");

    vm.clock.seek(41);
    const track = timeline.element.querySelector("g.track");
    const support = track.firstChild;
    t.equal(support.firstChild.nextSibling.tagName, "rect", "rect for loop");
});

test("Add threads", t => {
    const vm = VM();
    const timeline = Timeline(vm);

    const thread = vm.spawnAt(17).
        spawn(Thread().delay(23).instant(nop)).
        delay(31).
        instant(nop);

    vm.clock.seek(49);
    t.equal(timeline.element.querySelectorAll("g.track").length, 2, "one track per thread");
    t.equal(timeline.element.querySelectorAll("g.times rect").length, 4, "four time rects (0, 17, 40, 48)");
    t.equal(timeline.element.querySelectorAll("line[marker-end]").length, 1, "one arrow");
});

        </script>
    </head>
    <body>
        <p><a href="index.html">Back</a></p>
    </body>
</html>
