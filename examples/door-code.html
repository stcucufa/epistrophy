<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Door code example | Epistrophy</title>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <link rel="stylesheet" href="style.css"/>
        <style>

span.code {
    font-weight: bold;
}

div.keypad {
    --button-size: 4em;
    --gap: 0.5em;

    display: grid;
    width: calc(3 * var(--button-size) + 2 * var(--gap));
    margin: auto;
    grid-template-columns: repeat(3, var(--button-size));
    grid-template-rows: 3em repeat(4, var(--button-size));
    gap: var(--gap);
}

div.keypad output {
    grid-column-start: 1;
    grid-column-end: 4;
    font-size: 2em;
    text-align: center;
    line-height: 1.4em;
    border: solid thin;
    border-radius: 0.5rem;
}

div.keypad button {
    font-size: 2em;
}

        </style>
        <script type="module">
import { run, Fiber, First, cancelSiblings } from "../lib/shell.js";

const output = document.querySelector("div.keypad output");
const buttons = [...document.querySelectorAll("div.keypad button")];
const code = document.querySelector("span.code").textContent;

run().
    loop(φ => φ.
        // Reset code with 5 zero-width whitespace characters and setup the
        // timeout fiber with an infinite delay.
        call(fiber => {
            output.textContent = "\u200b\u200b\u200b\u200b\u200b";
            fiber.scope.timeout = fiber.scheduler.attachFiber(fiber, new Fiber().named("timeout").ramp(Infinity));
        }).
        spawn(φ => φ.
            // Shift the input buffer every time we have a key press, and
            // reset the timeout delay to 3 seconds before clearing the input
            // again without opening the door.
            loop(φ => φ.
                K(buttons).
                mapfirst(φ => φ.
                    event(({ value: button }) => button, "click").
                    call(({ value: button, scope: { timeout } }) => {
                        timeout.scheduler.resetRampDurationForFiber(timeout, 3000);
                        output.textContent = output.textContent.substr(1) + button.textContent;
                    })
                ),
                { loopShouldEnd: () => output.textContent === code }
            ).
            // We have the right code so cancel the timeout and set a new delay
            // before closing the door again.
            call(({ scope: { timeout } }) => { timeout.scheduler.cancelFiber(timeout); }).
            ramp(350).
            call(() => { output.textContent = "OPEN" }).
            ramp(2650)
        ).
        join(First)
    );

        </script>
    </head>
    <body>
        <h1>Door code example</h1>
        <div class="example">
            <div class="keypad">
                <output></output>

                <button type="button">7</button>
                <button type="button">8</button>
                <button type="button">9</button>

                <button type="button">4</button>
                <button type="button">5</button>
                <button type="button">6</button>

                <button type="button">1</button>
                <button type="button">2</button>
                <button type="button">3</button>

                <button type="button">A</button>
                <button type="button">0</button>
                <button type="button">B</button>
            </div>
        </div>
        <p>
            Type the door code (hint: it’s <span class="code">B6904</span>) on the keypad to be let in.
            The input resets after three seconds if there is no key press or the correct code was entered (during which
            time the door is open).
        </p>
        <details>
            <summary>Source</summary>
            <pre></pre>
        </details>
        <p><a href="index.html">Back</a></p>
        <script>document.querySelector("pre").textContent = document.querySelector("script").textContent;</script>
    </body>
</html>
