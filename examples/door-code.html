<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Door code example | Epistrophy</title>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <link rel="stylesheet" href="style.css"/>
        <style>

span.code {
    font-weight: bold;
}

        </style>
        <script type="module">
import { run, Fiber, First } from "../lib/shell.js";

import Keypad from "./keypad.js";
const keypad = new Keypad();
document.querySelector("div.example").appendChild(keypad.element);
keypad.div.focus();

const code = document.querySelector("span.code").textContent;

run().
    loop(φ => φ.
        // Reset code with 5 zero-width whitespace characters and setup the
        // timeout fiber with an infinite delay.
        call(fiber => {
            keypad.text = "\u200b\u200b\u200b\u200b\u200b";
            fiber.scope.timeout = fiber.scheduler.attachFiber(fiber, new Fiber().named("timeout").ramp(Infinity));
        }).
        spawn(φ => φ.
            // Shift the input buffer every time we have a key press, and
            // reset the timeout delay to 3 seconds before clearing the input
            // again without opening the door.
            loop(φ => φ.
                append(fiber => keypad.button(fiber)).
                call(({ value: button, scope: { timeout } }) => {
                    timeout.scheduler.resetRampDurationForFiber(timeout, 3000);
                    keypad.text = keypad.text.substring(1) + button;
                }),
                { loopShouldEnd: () => keypad.text === code }
            ).
            // We have the right code so cancel the timeout and set a new delay
            // before closing the door again.
            call(({ scope: { timeout } }) => { timeout.scheduler.cancelFiber(timeout); }).
            ramp(350).
            call(() => { keypad.text = "OPEN" }).
            ramp(2650)
        ).
        join(First)
    );

        </script>
    </head>
    <body>
        <h1>Door code example</h1>
        <div class="example"></div>
        <p>
            Type the door code (hint: it’s <span class="code">B6904</span>) on the keypad to be let in.
            The input resets after three seconds if there is no key press or the correct code was entered (during which
            time the door is open).
        </p>
        <details>
            <summary>Source</summary>
            <pre></pre>
        </details>
        <p><a href="index.html">Back</a></p>
        <script>document.querySelector("pre").textContent = document.querySelector("script").textContent;</script>
    </body>
</html>
