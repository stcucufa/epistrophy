<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Timer example | Epistrophy</title>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <link rel="stylesheet" href="style.css"/>
        <script type="module">
import Scheduler from "../lib/scheduler.js";
import { First } from "../lib/fiber.js";
import { K } from "../lib/util.js";

const [timer, elapsed] = document.querySelectorAll("span");
const range = document.querySelector("input");
const button = document.querySelector("button");
const progress = document.querySelector("progress");

Scheduler.run().
    spawn(fiber => fiber.
        repeat(fiber => fiber.
            exec(() => range.value).
            effect(({ value }) => {
                timer.textContent = `${value}s`;
                progress.max = value * 1000;
            }).
            event(range, "input")
        )
    ).
    spawn(fiber => fiber.
        repeat(fiber => fiber.
            event(button, "click").
            effect(() => {
                button.disabled = true;
            }).
            spawn(fiber => fiber.
                exec(K(0)).
                repeat(fiber => fiber.
                    effect(({ value }) => {
                        progress.value = value;
                        elapsed.textContent = `${(value / 1000).toFixed(1)}s`;
                    }).
                    delay(100).
                    exec((fiber, scheduler) => scheduler.now - fiber.beginTime),
                    { repeatShouldEnd: (_, { value }) => value > progress.max }
                )
            ).
            join().
            delay(1000).
            effect(() => {
                button.disabled = false;
                progress.value = 0;
                elapsed.textContent = "";
            })
        )
    );

        </script>
    </head>
    <body>
        <h1>Timer example</h1>
        <div class="example">
            <p>Timer:
                <input type="range" min="1" max="60" value="30"/>
                <span></span>
            </p>
            <p>
                <button type="button">Start</button>
                <progress value="0"></progress>
                <span></span>
            </p>
        </div>
        <p>
            Set a timer with the range input, and start it with the “Start” button. The timer can be set while it is
            running and will stop when it runs its course or gets set to a shorter time than currently elapsed. It
            resets one seconds after finishing.
        </p>
        <p>
            <span class="todo">TODO</span> Smooth animation with ramp.
        </p>
        <p>
            <span class="todo">TODO</span> Analog timer (with second hand).
        </p>
        <p>
            <span class="todo">TODO</span> Use an actual delay instead of checking the elapsed time in the repeat.
        </p>
        <h2>Source</h2>
        <pre></pre>
        <p><a href="index.html">Back</a></p>
        <script>document.querySelector("pre").textContent = document.querySelector("script").textContent;</script>
    </body>
</html>
