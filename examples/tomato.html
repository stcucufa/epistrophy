<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Flipbook animation example (tomato) | Epistrophy</title>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <link rel="stylesheet" href="style.css"/>
        <script type="module">
import Scheduler from "../lib/scheduler.js";
import Fiber, { All } from "../lib/fiber.js";

// FIXME 250A map/spawn
Fiber.prototype.map = function(f) {
    this.ops.push(scheduler => {
        if (!this.handleResult) {
            return;
        }
        if (!this.result.error && typeof this.result.value?.forEach === "function") {
            this.result.value.forEach((value, index) => {
                f(value, index, this.attach(scheduler), scheduler);
            });
        } else {
            f(this.result.error ?? this.result.value, 0, this.attach(scheduler), scheduler);
        }
    });
    return this;
};

const N = 18;

const fiber = Scheduler.run().
    exec(() => new Array(N).fill().map((_, i) => `tomato/tomato${(i + 1).toString().padStart(2, "0")}.png`)).
    map((src, _, fiber) => fiber.
        exec(async () => new Promise((resolve, reject) => {
            const image = new Image();
            image.src = src;
            if (image.complete) {
                resolve(image);
            } else {
                image.addEventListener("load", () => { resolve(image); });
                image.addEventListener("error", () => { reject(Error(`Cannot load image with src="${src}"`)); });
            }
        }))
    ).
    join(All).
    effect(({ value: images }) => {
        for (const image of images) {
            document.querySelector(".example").appendChild(image);
        }
    });

        </script>
    </head>
    <body>
        <h1>Flipbook animation example (tomato)</h1>
        <div class="example">
        </div>
        <h2>Source</h2>
        <pre></pre>
        <p><a href="index.html">Back</a></p>
        <script>document.querySelector("pre").textContent = document.querySelector("script").textContent;</script>
    </body>
</html>
